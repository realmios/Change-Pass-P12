<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ đổi mật khẩu P12</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/forge/1.3.1/forge.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="password"], input[type="file"] { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
        button { width: 100%; padding: 12px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 10px;}
        button:hover { background-color: #218838; }
        #status { margin-top: 20px; text-align: center; font-weight: bold; }
        .error { color: red; }
        .success { color: green; }
        .note { font-size: 0.85em; color: #666; margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px;}
    </style>
</head>
<body>

<div class="container">
    <h2>Đổi mật khẩu file .P12</h2>
    
    <div class="form-group">
        <label>1. Chọn file .p12</label>
        <input type="file" id="p12File" accept=".p12,.pfx">
    </div>

    <div class="form-group">
        <label>2. Mật khẩu CŨ</label>
        <input type="password" id="oldPassword" placeholder="Nhập mật khẩu hiện tại">
    </div>

    <div class="form-group">
        <label>3. Mật khẩu MỚI</label>
        <input type="text" id="newPassword" placeholder="Nhập mật khẩu mới muốn đặt">
    </div>

    <button onclick="changePassword()">Xử lý & Tải về</button>

    <div id="status"></div>

    <div class="note">
        <strong>Bảo mật:</strong> File của bạn được xử lý trực tiếp trên trình duyệt (Offline), không có dữ liệu nào được gửi đi máy chủ.
    </div>
</div>

<script>
    function changePassword() {
        const fileInput = document.getElementById('p12File');
        const oldPass = document.getElementById('oldPassword').value;
        const newPass = document.getElementById('newPassword').value;
        const statusDiv = document.getElementById('status');

        statusDiv.innerHTML = "Đang xử lý...";
        statusDiv.className = "";

        if (fileInput.files.length === 0) {
            statusDiv.innerHTML = "Vui lòng chọn file!";
            statusDiv.className = "error";
            return;
        }

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = function(e) {
            try {
                // 1. Đọc file P12 dưới dạng binary string
                const p12Der = e.target.result;
                const p12Asn1 = forge.asn1.fromDer(p12Der);
                
                // 2. Mở file P12 với mật khẩu cũ
                // Chuyển binary string sang forge buffer nếu cần, nhưng fromDer thường nhận string
                const p12 = forge.pkcs12.pkcs12FromAsn1(p12Asn1, oldPass);

                // 3. Lấy các túi (bags) chứa Key và Certificate
                // Chúng ta cần trích xuất dữ liệu ra để đóng gói lại với mật khẩu mới
                // Lưu ý: Logic này sẽ lấy tất cả safeBags và đóng gói lại.
                
                const newP12 = forge.pkcs12.toPkcs12Asn1(
                    p12.safeContent, 
                    p12.safeContent, // Dùng lại content cũ (thường chứa cả key và cert)
                    newPass,
                    {algorithm: '3des'} // Chuẩn mã hóa tương thích rộng rãi
                );
                
                // 4. Chuyển đổi sang định dạng để tải về
                const newP12Der = forge.asn1.toDer(newP12).getBytes();
                
                // Tạo Blob để tải về
                const byteArray = new Uint8Array(newP12Der.length);
                for (let i = 0; i < newP12Der.length; i++) {
                    byteArray[i] = newP12Der.charCodeAt(i);
                }
                
                const blob = new Blob([byteArray], { type: 'application/x-pkcs12' });
                const url = URL.createObjectURL(blob);
                
                // Tạo link tải ảo
                const a = document.createElement('a');
                a.href = url;
                a.download = 'new_password_' + file.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                statusDiv.innerHTML = "Thành công! File đang tải xuống.";
                statusDiv.className = "success";

            } catch (err) {
                console.error(err);
                statusDiv.innerHTML = "Lỗi: Sai mật khẩu cũ hoặc file hỏng.";
                statusDiv.className = "error";
            }
        };

        // Đọc file dưới dạng BinaryString để thư viện forge xử lý
        reader.readAsBinaryString(file);
    }
</script>

</body>
</html>
