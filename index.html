<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P12 Password Changer (Rebuild Mode)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/forge/1.3.1/forge.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f2f5; display: flex; justify-content: center; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 450px; }
        h2 { text-align: center; margin-top: 0; color: #333; }
        .group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; color: #555; }
        input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: 0.3s; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #log { margin-top: 20px; padding: 10px; background: #eee; border-radius: 4px; font-size: 13px; font-family: monospace; white-space: pre-wrap; display: none; }
        .error { color: #d9534f; }
        .success { color: #28a745; }
    </style>
</head>
<body>

<div class="card">
    <h2>Đổi Mật Khẩu P12</h2>
    
    <div class="group">
        <label>1. Chọn File .p12</label>
        <input type="file" id="fileIn" accept=".p12,.pfx">
    </div>

    <div class="group">
        <label>2. Mật khẩu CŨ</label>
        <input type="password" id="passOld" placeholder="Mật khẩu hiện tại của file">
    </div>

    <div class="group">
        <label>3. Mật khẩu MỚI</label>
        <input type="text" id="passNew" placeholder="Mật khẩu mới muốn đặt">
    </div>

    <button id="btnAction" onclick="processFile()">Xử lý & Tải về</button>
    
    <div id="log"></div>
</div>

<script>
    function log(msg, type = 'info') {
        const logDiv = document.getElementById('log');
        logDiv.style.display = 'block';
        const color = type === 'error' ? 'red' : (type === 'success' ? 'green' : 'black');
        logDiv.innerHTML += `<div style="color:${color}; margin-bottom: 4px;">- ${msg}</div>`;
    }

    function clearLog() {
        document.getElementById('log').innerHTML = '';
        document.getElementById('log').style.display = 'none';
    }

    function processFile() {
        clearLog();
        const fileInput = document.getElementById('fileIn');
        const pOld = document.getElementById('passOld').value;
        const pNew = document.getElementById('passNew').value;

        if (fileInput.files.length === 0) {
            log("Vui lòng chọn file trước!", 'error');
            return;
        }

        const file = fileInput.files[0];
        log("Đang đọc file: " + file.name);

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                // 1. Convert file sang định dạng Forge hiểu
                const fileBuffer = e.target.result;
                const p12Der = forge.util.createBuffer(fileBuffer);
                const p12Asn1 = forge.asn1.fromDer(p12Der);
                
                log("Đã đọc cấu trúc file. Đang giải mã...");

                // 2. Mở file P12 cũ
                // Dùng try-catch riêng cho đoạn này để bắt lỗi sai pass
                let p12;
                try {
                    p12 = forge.pkcs12.pkcs12FromAsn1(p12Asn1, pOld || "");
                } catch (decErr) {
                    console.error(decErr);
                    log("LỖI: Mật khẩu cũ không đúng hoặc file bị mã hóa bằng thuật toán lạ (OpenSSL 3+).", 'error');
                    return;
                }

                log("Giải mã thành công! Đang trích xuất Key & Cert...");

                // 3. TRÍCH XUẤT DỮ LIỆU (QUAN TRỌNG)
                // Thay vì copy nội dung, ta lấy hẳn Key và Cert ra
                
                // Lấy Private Key
                let keyBags = p12.getBags({ bagType: forge.pki.oids.pkcs8ShroudedKeyBag });
                let privateKey = null;
                // Nếu không tìm thấy ở pkcs8, thử tìm ở keyBag thường
                if (!keyBags[forge.pki.oids.pkcs8ShroudedKeyBag]) {
                     keyBags = p12.getBags({ bagType: forge.pki.oids.keyBag });
                     if (keyBags[forge.pki.oids.keyBag]) {
                         privateKey = keyBags[forge.pki.oids.keyBag][0].key;
                     }
                } else {
                    privateKey = keyBags[forge.pki.oids.pkcs8ShroudedKeyBag][0].key;
                }

                if (!privateKey) {
                    log("Lỗi: Không tìm thấy Private Key trong file này.", 'error');
                    return;
                }

                // Lấy Certificate Chain
                let certBags = p12.getBags({ bagType: forge.pki.oids.certBag });
                let chain = [];
                if (certBags[forge.pki.oids.certBag]) {
                    certBags[forge.pki.oids.certBag].forEach(function(bag) {
                        chain.push(bag.cert);
                    });
                }

                log(`Đã tìm thấy Key và ${chain.length} chứng chỉ.`);
                log("Đang đóng gói file P12 mới...");

                // 4. TẠO FILE P12 MỚI (REBUILD)
                // Sử dụng hàm toPkcs12Asn1 chuẩn của Forge
                const newP12Asn1 = forge.pkcs12.toPkcs12Asn1(
                    privateKey, 
                    chain, 
                    pNew, 
                    {
                        algorithm: '3des', // Dùng 3DES để tương thích tốt nhất
                        generateLocalKeyId: true,
                        friendlyName: 'New P12 File'
                    }
                );

                // 5. Tải về
                const newP12Der = forge.asn1.toDer(newP12Asn1).getBytes();
                const newP12Buffer = new Uint8Array(newP12Der.length);
                for (let i = 0; i < newP12Der.length; i++) {
                    newP12Buffer[i] = newP12Der.charCodeAt(i);
                }

                const blob = new Blob([newP12Buffer], { type: 'application/x-pkcs12' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'NEW_' + file.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                log("XONG! File đã được tải xuống.", 'success');

            } catch (err) {
                console.error(err);
                log("Lỗi không xác định: " + err.message, 'error');
                log("Hãy nhấn F12, chụp màn hình tab Console gửi để được hỗ trợ.", 'error');
            }
        };

        // Đọc dưới dạng ArrayBuffer (Chuẩn nhất cho file binary)
        reader.readAsArrayBuffer(file);
    }
</script>

</body>
</html>
