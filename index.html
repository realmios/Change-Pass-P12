<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Đổi Pass P12</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/forge/1.3.1/forge.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; background-color: #f9f9f9; }
        .box { background: #fff; padding: 20px; border-radius: 8px; border: 1px solid #ddd; max-width: 400px; margin: 0 auto; }
        input { width: 100%; padding: 8px; margin: 8px 0; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        button { width: 100%; padding: 10px; background: #007bff; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:hover { background: #0056b3; }
        #msg { margin-top: 10px; font-size: 14px; text-align: center; }
        .err { color: red; }
        .ok { color: green; }
    </style>
</head>
<body>

<div class="box">
    <h3 style="text-align:center; margin-top:0;">Đổi mật khẩu P12</h3>
    
    <label>Chọn file .p12:</label>
    <input type="file" id="f" accept=".p12,.pfx">
    
    <label>Mật khẩu cũ:</label>
    <input type="password" id="oldP" placeholder="Pass hiện tại">
    
    <label>Mật khẩu mới:</label>
    <input type="text" id="newP" placeholder="Pass mới">
    
    <button onclick="run()">Thực hiện & Tải về</button>
    <div id="msg"></div>
</div>

<script>
    function run() {
        var f = document.getElementById('f').files[0];
        var oldP = document.getElementById('oldP').value;
        var newP = document.getElementById('newP').value;
        var msg = document.getElementById('msg');

        if (!f) { msg.innerHTML = '<span class="err">Chưa chọn file!</span>'; return; }

        msg.innerHTML = 'Đang xử lý...';
        
        var r = new FileReader();
        // SỬA LỖI QUAN TRỌNG: Dùng ArrayBuffer thay vì BinaryString
        r.readAsArrayBuffer(f);
        
        r.onload = function(e) {
            try {
                // Chuyển ArrayBuffer thành Forge Buffer
                var buf = forge.util.createBuffer(e.target.result);
                var asn1 = forge.asn1.fromDer(buf);
                
                // Giải mã file P12
                var p12 = forge.pkcs12.pkcs12FromAsn1(asn1, oldP || "");
                
                // Lấy các KeyBags và CertBags
                // Lưu ý: Logic này sẽ lấy toàn bộ nội dung (SafeContent) và gói lại
                var safeContents = p12.safeContents;
                var bags = p12.getBags({bagType: forge.pki.oids.certBag});
                // Lấy thêm key bags
                var keyBags = p12.getBags({bagType: forge.pki.oids.pkcs8ShroudedKeyBag});
                
                // Tạo P12 mới
                // strict: false để bỏ qua lỗi nếu cấu trúc p12 hơi lạ
                var newP12Asn1 = forge.pkcs12.toPkcs12Asn1(
                    p12.safeContent, 
                    p12.safeContent, 
                    newP, 
                    {algorithm: '3des'}
                );

                var newDer = forge.asn1.toDer(newP12Asn1).getBytes();
                
                // Tải về
                var arr = new Uint8Array(newDer.length);
                for(var i=0; i<newDer.length; i++) arr[i] = newDer.charCodeAt(i);
                
                var blob = new Blob([arr], {type: 'application/x-pkcs12'});
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'new_' + f.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                msg.innerHTML = '<span class="ok">Thành công!</span>';
            } catch (ex) {
                console.error(ex);
                // Nếu lỗi, khả năng cao là sai pass hoặc thuật toán mã hóa quá mới
                msg.innerHTML = '<span class="err">Lỗi: Sai mật khẩu cũ hoặc định dạng file không hỗ trợ.</span>';
            }
        };
    }
</script>

</body>
</html>
